FROM dsegura97/ubseguridad

USER root

# Añadir repositorio oficial de PostgreSQL e instalar la última versión
RUN apt-get update && apt-get install -y --no-install-recommends \
    gnupg2 lsb-release curl ca-certificates \
    && curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/postgresql-keyring.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/postgresql-keyring.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list \
    && apt-get update && apt-get install -y --no-install-recommends \
    postgresql \
    postgresql-client \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Crear directorio de datos y asignar permisos
RUN mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql/data

# Crear directorio admin para el entrypoint
RUN mkdir -p /root/admin/postgre
WORKDIR /root/admin/postgre
COPY ./dockerfiles/postgre/admin/start.sh .
RUN chmod +x ./start.sh

EXPOSE 5432

ENTRYPOINT ["./start.sh"]